# VirtualIce: Half-synthetic CryoEM Micrograph Generator

VirtualIce is a feature-rich synthetic cryoEM micrograph generator that uses buffer cryoEM micrographs with junk and carbon masked out as real background. It projects PDB, EMDB, or local structures onto buffer cryoEM micrographs, simulating realistic imaging conditions by adding noise, dose damage, and applying CTF to particles. It outputs particle coordinates after masking out junk. It outputs particles if requested.

#### Features

- Generates synthetic cryoEM micrographs and particles from buffer images and PDB IDs, EMDB IDs, or local files.
- Creates coordinate files (.star, .mod, .coord), not including particles obscured by junk/substrate or too close to the edge.
- Adds Poisson noise to particle frames and Gaussian noise to particles.
- Adds dose-dependent damage to simulated frames.
- Applies the Contrast Transfer Function (CTF) to simulate microscope optics.
- Control over particle aggregation.
- Outputs micrographs in MRC, PNG, and JPEG formats.
- Multi-core processing.
- Extensive customization options including particle distribution, ice thickness, and microscope parameters.

## Requirements and Installation

VirtualIce requires Python 3, EMAN2, IMOD, and several dependencies, which can be installed using pip:

```bash
pip install mrcfile numpy opencv-python pandas scipy SimpleITK
```

To use VirtualIce, download the virtualice.py file directly and place it in your working directory or environment for use. Make it executable on Linux with this command: `chmod +x virtualice.py`.

## Usage

The script can be run from the command line and takes a number of arguments.

Basic example usage:

```
./virtualice.py -s 1TIM -n 10
```

Generates `-n` _10_ random micrographs of PDB `-s` _1TIM_.

## Arguments

- `-s`, `--structures`: Specify PDB ID(s), EMDB ID(s), local files, and/or 'r' for random PDB/EMDB structures.
- `-n`, `--num_images`: Number of micrographs to generate.

Advanced example usage:

```
./virtualice.py -s 1TIM r my_structure.mrc 11638 -n 3 -I -P -J -Q 90 -b 4 -D n -ps 2
```

Generates `-n` _3_ random micrographs of PDB `-s` _1TIM_, a <i>r</i>andom EMDB/PDB structure, a local structure called _my_structure.mrc_, and EMD-_11638_. Outputs an `-I` IMOD .mod coordinate file, `-P` png, and `-J` jpeg (quality `-Q` _90_) for each micrograph, and bins `-b` all images by _4_. Uses a `-D` <i>n</i>on-random distribution of particles and `-ps` parallelizes micrograph generation across _2_ CPUs.

## Arguments

- `-I`, `--imod_coordinate_file`: Also output one IMOD .mod coordinate file per micrograph.
- `-P`, `--png`: Output in PNG format.
- `-P`, `--jpeg`: Output in JPEG format.
- `-Q`, `--jpeg-quality`: JPEG image quality.
- `-b`, `--binning`: Bin micrographs by downsampling.
- `-D`, `--distribution`: Distribution type for generating particle locations.
- `-ps`, `--parallellize_structures`: Parallel processes for micrograph generation across the structures requested.

Additional arguments exist for fine-tuning the generation process including ice thickness, junk filtering, and CTF parameters.

## Ethical Use Agreement

VirtualIce is under the MIT License, allowing broad usage freedom, but we emphasize using it responsibly and ethically via these guidelines:

### Intended Use

VirtualIce is designed for educational and research purposes, specifically to aid in the development, testing, and validation of cryoEM image analysis algorithms by generating synthetic cryoEM micrographs and particles.

### Ethical Considerations

- **Transparency**: Any data generated using VirtualIce should be clearly marked as synthetic when published or shared, to distinguish it from real experimental data.
- **No Misrepresentation**: Users should not present synthetic data generated by VirtualIce as real data from physical experiments in any publications or presentations unless explicitly stated.
- **Research Integrity**: We encourage users to uphold the highest standards of scientific integrity in their work, ensuring that the use of synthetic data does not mislead, deceive, or otherwise harm the scientific community or the public.

## Issues and Support

If you encounter any problems or have any questions about the script, please [Submit an Issue](https://github.com/alexjnoble/VirtualIce/issues).

## Contributions

Contributions are welcome! Please open a [Pull Request](https://github.com/alexjnoble/VirtualIce/pulls) or [Issue](https://github.com/alexjnoble/VirtualIce/issues).

## Author

This script was written by Alex J. Noble with assistance from OpenAI's GPT-4(o), Anthropic's Clause 3, and Google's Gemini models, 2023-2024 at SEMC.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.
The Ethical Use Agreement is compatible with the MIT License, providing guidelines and recommendations for responsible use without legally restricting software use.
